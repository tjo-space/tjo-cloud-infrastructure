OPENWRT_VERSION := "24.10.5"

default:
  @just --list

download:
  #!/usr/bin/env sh
  set -euo pipefail
  mkdir -p {{source_directory()}}/iso

  curl -L -o - https://downloads.openwrt.org/releases/{{ OPENWRT_VERSION }}/targets/x86/64/openwrt-{{ OPENWRT_VERSION }}-x86-64-generic-ext4-combined-efi.img.gz \
    | gunzip > {{source_directory()}}/iso/openwrt.img

apply:
  #!/usr/bin/env sh
  cd {{source_directory()}}/terraform
  tofu init
  tofu apply

destroy:
  #!/usr/bin/env sh
  cd {{source_directory()}}/terraform
  tofu destroy

destroy-only node:
  #!/usr/bin/env sh
  cd {{source_directory()}}/terraform
  tofu destroy -target='proxmox_virtual_environment_vm.nodes["{{node}}"]'

reboot node:
  #!/usr/bin/env sh
  echo "- Rebooting {{node}}"
  ssh root@{{node}}.network.tjo.cloud 'reboot'

reboot-all:
  #!/usr/bin/env sh
  set -euo pipefail
  for node in $(cat config.yaml | yq -r '.nodes | keys | .[]')
  do
    just reboot ${node} | ts ${node}
  done

configure-all:
  #!/usr/bin/env sh
  set -euo pipefail
  for node in $(cat vars.secrets.yaml | yq -r '.nodes | keys | .[]')
  do
    just configure ${node}} | ts ${node}
  done

configure node:
  #!/usr/bin/env sh
  set -euo pipefail

  export NODE="{{node}}"
  export ROLE="$(cat vars.secrets.yaml | yq -r '.nodes["{{node}}"].role')"
  export IPV6="$(cat vars.secrets.yaml | yq -r '.nodes["{{node}}"].internal.ipv6.address' | cut -d '/' -f1)"
  #export IPV6="fd74:6a6f::a8bb:ff:fe11:c230"
  export TMPDIR="$(mktemp -d)"
  export CONFIG="{{source_directory()}}/vars.secrets.yaml"

  echo "Configuring ${NODE} as ${ROLE}"

  ssh-copy-id root@${IPV6}

  cd {{source_directory()}}/root-${ROLE}

  echo "- Generating configuration ${TMPDIR}..."
  for file in $(find * -type f)
  do
    echo " - $file"
    mkdir -p ${TMPDIR}/$(dirname $file)
    gomplate --file $file --datasource config=${CONFIG} > ${TMPDIR}/${file}
  done

  echo "- Copying configuration to node..."
  pushd ${TMPDIR}
  for file in $(find * -type f)
  do
    directory=$(dirname $file)
    echo "- $file"
    cat $file | ssh -J root@nevaroo.system.tjo.cloud root@${IPV6} "mkdir -p /$(dirname $file) && cat > /$file"
  done
  popd

  cat {{source_directory()}}/configure.${ROLE}.sh | ssh -J root@nevaroo.system.tjo.cloud root@${IPV6} 'sh' | ts ${NODE}
