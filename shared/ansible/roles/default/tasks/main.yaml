- name: Upgrade APT Packages
  ansible.builtin.apt:
    upgrade: "full"
    update_cache: yes

- name: Fetch metadata
  ansible.builtin.slurp:
    src: /etc/tjo.cloud/meta.json
  register: tjo_cloud_metadata_raw

- name: Save metadata as fact
  set_fact:
    tjo_cloud_metadata: "{{ tjo_cloud_metadata_raw.content | b64decode | from_json }}"

- name: Write version.txt
  ansible.builtin.copy:
    content: "{{ version }}"
    dest: /etc/tjo.cloud/version.txt
    mode: '0444'

- name: Configure authorized keys
  ansible.posix.authorized_key:
    user: bine
    state: present
    exclusive: true
    key: "{{ lookup('ansible.builtin.dict', ssh_keys) | map(attribute='value') | join('\n')}}"

- name: Configure Systemd Resolved
  ansible.builtin.template:
    src: root/etc/systemd/resolved.conf
    dest: /etc/systemd/resolved.conf
    mode: '0644'
    owner: "root"
    group: "root"
  notify: Restart systemd-resolved
  when: configure_resolved


- name: Create /usr/local/share/ca-certificates/ca-tjo-cloud directory
  ansible.builtin.file:
    state: directory
    path: "/usr/local/share/ca-certificates/ca-tjo-cloud/"
    mode: "0755"
    owner: "root"
    group: "root"

- name: Write ca-tjo-cloud root certificate
  ansible.builtin.copy:
    dest: /usr/local/share/ca-certificates/ca-tjo-cloud.crt
    content: |
      -----BEGIN CERTIFICATE-----
      MIIBfzCCASSgAwIBAgIQTwBj3msM0GPYkUSHuEsKEjAKBggqhkjOPQQDAjAeMRww
      GgYDVQQDExNjYS50am8uY2xvdWQgLSBSb290MCAXDTI2MDIwNjIwNTc0MFoYDzIw
      NTEwMzE0MTI1NzQwWjAeMRwwGgYDVQQDExNjYS50am8uY2xvdWQgLSBSb290MFkw
      EwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAENghQfaCunCDzn0BmU8vI5X79OAqZ7Uob
      8tM38BJmvUmafJMyxpvlIKNgotXJfnTw1GN5mR6u4eqvSRclhUcRtKNCMEAwDgYD
      VR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFD0gfxAPGvuX
      jmqfZ1CreFQT+WuQMAoGCCqGSM49BAMCA0kAMEYCIQCY0suGAsNGx7n2+F+Z786Q
      dubTJY1VA3fqwc0ZpO+AtQIhAOmeM2O7iFarM2KILzS5189DsdNIn5pp9v5uLOSX
      T8+p
      -----END CERTIFICATE-----

- name: Run update-ca-certificates
  ansible.builtin.command: update-ca-certificates

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
